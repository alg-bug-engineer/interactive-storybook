# Bug ä¿®å¤æ€»ç»“

**æ—¥æœŸ**: 2026-02-11
**ç‰ˆæœ¬**: 1.0

---

## ğŸ› å·²ä¿®å¤çš„é—®é¢˜

### Bug 1: ç¼ºå°‘ get_current_user_optional å¯¼å…¥

**é—®é¢˜æè¿°**:
- é”™è¯¯ç±»å‹: `NameError: name 'get_current_user_optional' is not defined`
- ä½ç½®: `backend/app/routers/story.py` line 37
- å½±å“èŒƒå›´: æ‰€æœ‰æ•…äº‹ API ç«¯ç‚¹æ— æ³•å¯åŠ¨

**æ ¹æœ¬åŸå› **:
åœ¨å®ç°åŒæœåŠ¡æ¶æ„æ—¶ï¼Œä¿®æ”¹äº†ä»£ç ä½¿ç”¨ `get_current_user_optional`ï¼ˆå…è®¸æœªç™»å½•ç”¨æˆ·è®¿é—®ï¼‰ï¼Œä½†å¿˜è®°åœ¨æ–‡ä»¶é¡¶éƒ¨å¯¼å…¥è¯¥å‡½æ•°ã€‚

**ä¿®å¤æ–¹æ³•**:
```python
# Before
from app.routers.auth import get_current_user

# After
from app.routers.auth import get_current_user, get_current_user_optional
```

**æ–‡ä»¶**: `backend/app/routers/story.py`
**æäº¤**: 02d8e66

---

### Bug 2: éŸ³é¢‘è·¯å¾„å¤„ç†é”™è¯¯

**é—®é¢˜æè¿°**:
- TTS éŸ³é¢‘ç”Ÿæˆè¿”å›çš„è·¯å¾„åŒ…å«å†—ä½™çš„ "backend/" å‰ç¼€
- å¯¼è‡´å‰ç«¯æ— æ³•æ­£ç¡®è®¿é—®éŸ³é¢‘æ–‡ä»¶
- ç¤ºä¾‹: `data/audio/tts/story_xxx_0_voice.mp3` å˜æˆ `backend/data/audio/tts/...`

**æ ¹æœ¬åŸå› **:
`tts_generation_service.py` åœ¨æ„å»ºéŸ³é¢‘è·¯å¾„æ—¶ä½¿ç”¨äº†ç»å¯¹è·¯å¾„ï¼Œè€ŒéŸ³é¢‘è·¯ç”±æœŸæœ›çš„æ˜¯ç›¸å¯¹è·¯å¾„ï¼ˆç›¸å¯¹äº backend/ ç›®å½•ï¼‰ã€‚

**ä¿®å¤æ–¹æ³•**:
```python
# Before (line 48-50)
audio_file = TTS_AUDIO_DIR / audio_filename
return str(audio_file)  # è¿”å› "backend/data/audio/tts/..."

# After
audio_file = TTS_AUDIO_DIR / audio_filename
return audio_file.relative_to("backend").as_posix()  # è¿”å› "data/audio/tts/..."
```

**æ–‡ä»¶**: `backend/app/services/tts_generation_service.py`
**æäº¤**: 87557be

---

### Bug 3: è§†é¢‘ç”Ÿæˆé‡æ–°ç”ŸæˆéŸ³é¢‘

**é—®é¢˜æè¿°**:
- ç—‡çŠ¶: è§†é¢‘ç”Ÿæˆæ—¥å¿—æ˜¾ç¤º "[è§†é¢‘æœåŠ¡] âš ï¸ æ²¡æœ‰å¯ç”¨çš„éŸ³é¢‘ï¼Œå°†å¯¼å‡ºæ— å£°è§†é¢‘"
- ç”¨æˆ·åé¦ˆ: "ä»ç”»å»Šæ‰“å¼€æ˜¯æœ‰å£°éŸ³çš„"ï¼ˆè¯´æ˜éŸ³é¢‘æ–‡ä»¶å­˜åœ¨ï¼‰
- å½±å“: è§†é¢‘ç”Ÿæˆé€Ÿåº¦æ…¢ï¼Œé‡å¤ç”Ÿæˆå·²æœ‰éŸ³é¢‘

**æ ¹æœ¬åŸå› **:
`video_service.py` åœ¨æ‹¼æ¥è§†é¢‘æ—¶ç›´æ¥è°ƒç”¨ `generate_tts_audio()` ç”Ÿæˆæ–°éŸ³é¢‘ï¼Œè€Œæ²¡æœ‰æ£€æŸ¥ `data/audio/tts/` ç›®å½•ä¸­æ˜¯å¦å·²æœ‰ç¼“å­˜çš„éŸ³é¢‘æ–‡ä»¶ã€‚ç”»å»Šæ’­æ”¾ä½¿ç”¨çš„æ˜¯ç¼“å­˜éŸ³é¢‘ï¼Œä½†è§†é¢‘ç”Ÿæˆä¸å¤ç”¨ã€‚

**ä¿®å¤æ–¹æ³•**:
```python
# Before (line 850-864)
if enable_audio and seg_i < len(segments) and segments[seg_i].text:
    audio_path = temp_dir / f"audio_{k:03d}.mp3"
    audio_file = await generate_tts_audio(
        text=segments[seg_i].text,
        output_path=str(audio_path),
        voice_id="zh-CN-XiaoxiaoNeural",
    )
    if audio_file:
        audio_clips.append(audio_file)
    else:
        audio_clips.append("")

# After (line 851-889)
if enable_audio and seg_i < len(segments) and segments[seg_i].text:
    # ä¼˜å…ˆæŸ¥æ‰¾å·²ç¼“å­˜çš„éŸ³é¢‘æ–‡ä»¶
    cached_audio = None

    # 1. æ£€æŸ¥ TTS ç¼“å­˜ç›®å½•ï¼ˆedge-ttsï¼‰
    from app.services.tts_service import TTS_AUDIO_DIR, DEFAULT_VOICE_ID

    # å°è¯•å¸¸ç”¨éŸ³è‰²çš„ç¼“å­˜æ–‡ä»¶
    common_voices = [DEFAULT_VOICE_ID, "zh-CN-XiaoxiaoNeural", "zh-CN-YunxiNeural"]
    for voice in common_voices:
        cached_path = TTS_AUDIO_DIR / f"{story_id}_{seg_i}_{voice}.mp3"
        if cached_path.exists() and cached_path.stat().st_size > 0:
            cached_audio = str(cached_path)
            logger.info(f"[è§†é¢‘æœåŠ¡] âœ… ä½¿ç”¨å·²ç¼“å­˜çš„éŸ³é¢‘: {cached_path.name}")
            break

    # 2. å¦‚æœæ²¡æœ‰ç¼“å­˜ï¼Œåˆ™ç”Ÿæˆæ–°éŸ³é¢‘
    if not cached_audio:
        audio_path = temp_dir / f"audio_{k:03d}.mp3"
        logger.info(f"[è§†é¢‘æœåŠ¡] æœªæ‰¾åˆ°ç¼“å­˜éŸ³é¢‘ï¼Œä¸ºç‰‡æ®µ {k} ç”Ÿæˆæ–°éŸ³é¢‘")
        try:
            audio_file = await generate_tts_audio(
                text=segments[seg_i].text,
                output_path=str(audio_path),
                voice_id=DEFAULT_VOICE_ID,
            )
            if audio_file:
                logger.info(f"[è§†é¢‘æœåŠ¡] ç‰‡æ®µ {k} éŸ³é¢‘ç”ŸæˆæˆåŠŸ: {audio_file}")
                audio_clips.append(audio_file)
            else:
                logger.warning(f"[è§†é¢‘æœåŠ¡] âš ï¸ ç‰‡æ®µ {k} éŸ³é¢‘ç”Ÿæˆå¤±è´¥ï¼Œå°†è·³è¿‡éŸ³é¢‘")
                audio_clips.append("")
        except Exception as e:
            logger.error(f"[è§†é¢‘æœåŠ¡] âŒ ç‰‡æ®µ {k} éŸ³é¢‘ç”Ÿæˆå¼‚å¸¸: {e}")
            audio_clips.append("")
    else:
        # ä½¿ç”¨ç¼“å­˜çš„éŸ³é¢‘
        audio_clips.append(cached_audio)
```

**ä¼˜åŒ–æ•ˆæœ**:
- âœ… å¤ç”¨ç”»å»Šæ’­æ”¾çš„éŸ³é¢‘æ–‡ä»¶ï¼Œä¿è¯ä¸€è‡´æ€§
- âš¡ è§†é¢‘ç”Ÿæˆé€Ÿåº¦æå‡ï¼ˆé¿å…é‡å¤ç”ŸæˆéŸ³é¢‘ï¼‰
- ğŸ“Š å‡å°‘ TTS æœåŠ¡è°ƒç”¨æ¬¡æ•°
- ğŸ¯ ç»Ÿä¸€éŸ³é¢‘ç¼“å­˜ç­–ç•¥

**æ–‡ä»¶**: `backend/app/services/video_service.py`
**æäº¤**: fc9d9a5

---

## ğŸ“Š ä¿®å¤ç»Ÿè®¡

| Bug ID | ç±»å‹ | ä¸¥é‡æ€§ | ä¿®å¤æ—¶é—´ | æäº¤å“ˆå¸Œ |
|--------|------|--------|----------|---------|
| Bug 1 | å¯¼å…¥é”™è¯¯ | ğŸ”´ é«˜ï¼ˆé˜»æ­¢å¯åŠ¨ï¼‰ | 5åˆ†é’Ÿ | 02d8e66 |
| Bug 2 | è·¯å¾„é”™è¯¯ | ğŸŸ¡ ä¸­ï¼ˆå½±å“åŠŸèƒ½ï¼‰ | 10åˆ†é’Ÿ | 87557be |
| Bug 3 | ç¼“å­˜æœªä½¿ç”¨ | ğŸŸ¡ ä¸­ï¼ˆæ€§èƒ½é—®é¢˜ï¼‰ | 15åˆ†é’Ÿ | fc9d9a5 |

---

## ğŸ§ª éªŒè¯æµ‹è¯•

### Bug 1 éªŒè¯
```bash
# å¯åŠ¨åç«¯æœåŠ¡ï¼Œç¡®è®¤æ—  NameError
cd backend
uvicorn app.main:app --reload --host 0.0.0.0 --port 1001

# é¢„æœŸ: æœåŠ¡æ­£å¸¸å¯åŠ¨ï¼Œæ— é”™è¯¯æ—¥å¿—
```

### Bug 2 éªŒè¯
```bash
# åˆ›å»ºæ•…äº‹å¹¶è·å–éŸ³é¢‘
curl -X POST http://localhost:1001/api/story/start \
  -H "Content-Type: application/json" \
  -d '{"theme":"æµ‹è¯•æ•…äº‹","total_pages":3}'

# ä¿å­˜è¿”å›çš„ story_id

curl "http://localhost:1001/api/story/{story_id}/segment/0/audio"

# é¢„æœŸ: è¿”å›çš„ audio_path æ ¼å¼ä¸º "data/audio/tts/story_xxx_0_voice.mp3"
# è®¿é—® http://localhost:1001/api/audio/data/audio/tts/story_xxx_0_voice.mp3 èƒ½æ­£å¸¸æ’­æ”¾
```

### Bug 3 éªŒè¯
```bash
# 1. åˆ›å»ºæ•…äº‹å¹¶æ’­æ”¾éŸ³é¢‘ï¼ˆç”Ÿæˆç¼“å­˜ï¼‰
# 2. ç”Ÿæˆè§†é¢‘
curl -X POST http://localhost:1001/api/story/{story_id}/video \
  -H "Content-Type: application/json"

# è§‚å¯Ÿåç«¯æ—¥å¿—
tail -f backend/logs/app.log | grep "è§†é¢‘æœåŠ¡"

# é¢„æœŸæ—¥å¿—:
# [è§†é¢‘æœåŠ¡] âœ… ä½¿ç”¨å·²ç¼“å­˜çš„éŸ³é¢‘: story_xxx_0_zh-CN-XiaoxiaoNeural.mp3
# [è§†é¢‘æœåŠ¡] âœ… æˆåŠŸç”Ÿæˆ N ä¸ªè§†é¢‘ç‰‡æ®µï¼ŒN/N ä¸ªéŸ³é¢‘ç‰‡æ®µ
```

---

## ğŸ¯ æ ¹æœ¬åŸå› åˆ†æ

### å…±åŒæ¨¡å¼
è¿™ä¸‰ä¸ª bug éƒ½æ˜¯åœ¨å®ç°**åŒæœåŠ¡æ¶æ„**æ—¶å¼•å…¥çš„ï¼š

1. **Bug 1**: å¤§èŒƒå›´é‡æ„æ—¶é—æ¼å¯¼å…¥æ›´æ–°
2. **Bug 2**: è·¯å¾„å¤„ç†é€»è¾‘ä¸ä¸€è‡´ï¼ˆç»å¯¹è·¯å¾„ vs ç›¸å¯¹è·¯å¾„ï¼‰
3. **Bug 3**: æ–°åŠŸèƒ½æœªå¤ç”¨ç°æœ‰ç¼“å­˜æœºåˆ¶

### é¢„é˜²æªæ–½
1. **å¯¼å…¥æ£€æŸ¥**: ä½¿ç”¨ linter è‡ªåŠ¨æ£€æµ‹æœªå¯¼å…¥çš„ç¬¦å·
2. **è·¯å¾„æ ‡å‡†åŒ–**: ç»Ÿä¸€ä½¿ç”¨ç›¸å¯¹è·¯å¾„æˆ–ç»å¯¹è·¯å¾„ï¼Œæ·»åŠ è·¯å¾„è½¬æ¢å·¥å…·å‡½æ•°
3. **ç¼“å­˜ä¼˜å…ˆ**: å»ºç«‹"å…ˆæ£€æŸ¥ç¼“å­˜ï¼Œå†ç”Ÿæˆ"çš„ç¼–ç åŸåˆ™
4. **é›†æˆæµ‹è¯•**: æ·»åŠ ç«¯åˆ°ç«¯æµ‹è¯•è¦†ç›–ä¸»è¦ç”¨æˆ·æµç¨‹

---

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [åŒæœåŠ¡æ¶æ„å®æ–½æ€»ç»“](./IMPLEMENTATION_2026-02-11.md)
- [æµ‹è¯•æŒ‡å—](./TESTING_GUIDE_2026-02-11.md)
- [æ€§èƒ½ä¼˜åŒ–æ€»ç»“](./PERFORMANCE_OPTIMIZATION_2026-02-11.md)

---

**ä¿®å¤å®Œæˆæ—¥æœŸ**: 2026-02-11
**å¼€å‘è€…**: Claude Code Agent
**çŠ¶æ€**: âœ… å…¨éƒ¨ä¿®å¤å¹¶éªŒè¯
