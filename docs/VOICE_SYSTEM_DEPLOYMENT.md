# éŸ³è‰²ç³»ç»Ÿéƒ¨ç½²ä¸æµ‹è¯•æŒ‡å—

## ä¸€ã€å·²å®Œæˆçš„åŠŸèƒ½

### Phase 0: PRD æ–‡æ¡£ âœ…
- âœ… äº§å“éœ€æ±‚æ–‡æ¡£ï¼ˆPRD_VOICE_SYSTEM.mdï¼‰
- âœ… éŸ³è‰²åˆ—è¡¨å®šä¹‰ï¼ˆ8ä¸ªéŸ³è‰²ï¼‰
- âœ… æŠ€æœ¯æ¶æ„è®¾è®¡
- âœ… æˆåŠŸæŒ‡æ ‡å®šä¹‰

### Phase 1: æ ¸å¿ƒåŠŸèƒ½ âœ…
- âœ… åç«¯éŸ³è‰²æœåŠ¡ï¼ˆTTS åŸºäº edge-ttsï¼‰
- âœ… éŸ³è‰² APIï¼ˆåˆ—è¡¨ã€è¯•å¬ã€åå¥½ä¿å­˜ï¼‰
- âœ… ç”¨æˆ·åå¥½æŒä¹…åŒ–ï¼ˆå‰ç«¯ LocalStorage + åç«¯ç”¨æˆ·é…ç½®ï¼‰
- âœ… å‰ç«¯éŸ³è‰²çŠ¶æ€ç®¡ç†ï¼ˆZustandï¼‰
- âœ… éŸ³è‰²é€‰æ‹©å™¨ç»„ä»¶
- âœ… éŸ³é¢‘æ’­æ”¾å™¨ç»„ä»¶ï¼ˆå€é€Ÿã€è¿›åº¦æ¡ï¼‰

### Phase 2: äº¤äº’ä¸ UI æ‰“ç£¨ âœ…
- âœ… éŸ³è‰²å¡ç‰‡å±•ç¤ºï¼ˆæ¨è vs æ›´å¤šéŸ³è‰²ï¼‰
- âœ… è¯•å¬åŠŸèƒ½ï¼ˆä¸€é”®æ’­æ”¾ç¤ºä¾‹éŸ³é¢‘ï¼‰
- âœ… é€‰ä¸­çŠ¶æ€é«˜äº®
- âœ… æ’­æ”¾å™¨å€é€Ÿæ§åˆ¶ï¼ˆ0.75x - 2xï¼‰
- âœ… è¿›åº¦æ¡æ‹–æ‹½
- âœ… æ—¶é•¿æ˜¾ç¤º

## äºŒã€é¡¹ç›®ç»“æ„

### åç«¯æ–°å¢æ–‡ä»¶
```
backend/
â”œâ”€â”€ app/
â”‚   â”œâ”€â”€ constants/
â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â””â”€â”€ voices.py              # éŸ³è‰²å¸¸é‡å®šä¹‰
â”‚   â”œâ”€â”€ routers/
â”‚   â”‚   â”œâ”€â”€ audio.py                # éŸ³é¢‘æ–‡ä»¶æœåŠ¡
â”‚   â”‚   â””â”€â”€ voices.py               # éŸ³è‰² API
â”‚   â””â”€â”€ services/
â”‚       â””â”€â”€ tts_service.py          # TTS è¯­éŸ³åˆæˆæœåŠ¡
â”œâ”€â”€ data/
â”‚   â””â”€â”€ audio/
â”‚       â”œâ”€â”€ preview/                # é¢„è§ˆéŸ³é¢‘å­˜å‚¨
â”‚       â””â”€â”€ tts/                    # TTS éŸ³é¢‘ç¼“å­˜
â””â”€â”€ requirements.txt                # æ–°å¢ edge-tts>=6.1.0
```

### å‰ç«¯æ–°å¢æ–‡ä»¶
```
frontend/
â””â”€â”€ src/
    â”œâ”€â”€ components/
    â”‚   â”œâ”€â”€ AudioPlayer.tsx         # éŸ³é¢‘æ’­æ”¾å™¨ç»„ä»¶
    â”‚   â””â”€â”€ VoiceSelector.tsx       # éŸ³è‰²é€‰æ‹©å™¨ç»„ä»¶
    â”œâ”€â”€ stores/
    â”‚   â””â”€â”€ voiceStore.ts           # éŸ³è‰²çŠ¶æ€ç®¡ç†
    â””â”€â”€ services/
        â””â”€â”€ api.ts                  # æ–°å¢éŸ³è‰²ç›¸å…³ API
```

## ä¸‰ã€éƒ¨ç½²æ­¥éª¤

### 1. åç«¯éƒ¨ç½²

#### å®‰è£…ä¾èµ–
```bash
cd backend
pip install -r requirements.txt
```

#### éªŒè¯ edge-tts å®‰è£…
```bash
edge-tts --list-voices | grep "zh-CN"
```

åº”è¯¥çœ‹åˆ° 8 ä¸ªä¸­æ–‡éŸ³è‰²ï¼š
- zh-CN-XiaoxiaoNeural
- zh-CN-XiaoyiNeural
- zh-CN-YunjianNeural
- zh-CN-YunxiNeural
- zh-CN-YunxiaNeural
- zh-CN-YunyangNeural
- zh-CN-liaoning-XiaobeiNeural
- zh-CN-shaanxi-XiaoniNeural

#### å¯åŠ¨åç«¯
```bash
cd backend
uvicorn app.main:app --reload --host 0.0.0.0 --port 1001
```

### 2. å‰ç«¯éƒ¨ç½²

#### å®‰è£…ä¾èµ–ï¼ˆå¦‚éœ€è¦ï¼‰
```bash
cd frontend
npm install
```

#### å¯åŠ¨å‰ç«¯
```bash
npm run dev
```

## å››ã€åŠŸèƒ½æµ‹è¯•æ¸…å•

### 4.1 éŸ³è‰²é€‰æ‹©å™¨æµ‹è¯•
- [ ] æ‰“å¼€ä¸»é¡µï¼Œç‚¹å‡»å³ä¸Šè§’"ğŸ™ï¸ éŸ³è‰²"æŒ‰é’®
- [ ] æŸ¥çœ‹æ˜¯å¦æ˜¾ç¤º 3 ä¸ªæ¨èéŸ³è‰²ï¼ˆæ™“æ™“ã€æ™“ä¼Šã€äº‘å¥ï¼‰
- [ ] æŸ¥çœ‹"æ›´å¤šéŸ³è‰²"åŒºåŸŸæ˜¯å¦æ˜¾ç¤ºå…¶ä»– 5 ä¸ªéŸ³è‰²
- [ ] ç‚¹å‡»ä»»æ„éŸ³è‰²çš„"â–¶ï¸ è¯•å¬"æŒ‰é’®
- [ ] ç¡®è®¤èƒ½å¬åˆ°é¢„è§ˆéŸ³é¢‘ï¼ˆçº¦ 10 ç§’ï¼‰
- [ ] ç‚¹å‡»å…¶ä»–éŸ³è‰²å¡ç‰‡ï¼Œç¡®è®¤é€‰ä¸­çŠ¶æ€åˆ‡æ¢
- [ ] å…³é—­éŸ³è‰²é€‰æ‹©å™¨ï¼Œé‡æ–°æ‰“å¼€ï¼Œç¡®è®¤é€‰ä¸­çŠ¶æ€ä¿æŒ

### 4.2 éŸ³è‰²æŒä¹…åŒ–æµ‹è¯•
- [ ] é€‰æ‹©ä¸€ä¸ªéé»˜è®¤éŸ³è‰²ï¼ˆå¦‚"æ™“ä¼Š"ï¼‰
- [ ] åˆ·æ–°é¡µé¢ï¼Œç¡®è®¤å³ä¸Šè§’æ˜¾ç¤º"æ™“ä¼Š"
- [ ] æ‰“å¼€éŸ³è‰²é€‰æ‹©å™¨ï¼Œç¡®è®¤"æ™“ä¼Š"ä»è¢«é€‰ä¸­
- [ ] ç™»å½•è´¦å·åï¼Œåˆ‡æ¢éŸ³è‰²
- [ ] é€€å‡ºç™»å½•ï¼Œé‡æ–°ç™»å½•ï¼Œç¡®è®¤éŸ³è‰²è®¾ç½®ä¿æŒ

### 4.3 æ’­æ”¾å™¨æµ‹è¯•ï¼ˆæš‚æœªé›†æˆåˆ°æ•…äº‹æ’­æ”¾ï¼‰
- [ ] éŸ³é¢‘æ’­æ”¾/æš‚åœ
- [ ] è¿›åº¦æ¡æ‹–æ‹½
- [ ] å€é€Ÿåˆ‡æ¢ï¼ˆ0.75x / 1x / 1.25x / 1.5x / 2xï¼‰
- [ ] æ—¶é•¿æ˜¾ç¤ºå‡†ç¡®

### 4.4 API æµ‹è¯•

#### è·å–éŸ³è‰²åˆ—è¡¨
```bash
curl http://localhost:1001/api/voices/list
```

é¢„æœŸè¿”å›ï¼š
```json
{
  "voices": [...],
  "default_voice_id": "zh-CN-XiaoxiaoNeural",
  "tts_available": true
}
```

#### è¯•å¬éŸ³è‰²
```bash
curl http://localhost:1001/api/voices/preview/zh-CN-XiaoxiaoNeural
```

é¢„æœŸè¿”å›ï¼š
```json
{
  "voice_id": "zh-CN-XiaoxiaoNeural",
  "audio_url": "/api/audio/data/audio/preview/zh-CN-XiaoxiaoNeural.mp3",
  "voice_info": {...}
}
```

#### ä¿å­˜ç”¨æˆ·åå¥½ï¼ˆéœ€ç™»å½•ï¼‰
```bash
curl -X POST http://localhost:1001/api/voices/preferences \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer YOUR_TOKEN" \
  -d '{"preferred_voice":"zh-CN-XiaoyiNeural","playback_speed":1.25}'
```

## äº”ã€ä¸‹ä¸€æ­¥é›†æˆå·¥ä½œï¼ˆåç»­å¼€å‘ï¼‰

### 5.1 æ•…äº‹ TTS é›†æˆ
éœ€è¦ä¿®æ”¹çš„æ–‡ä»¶ï¼š
- `backend/app/services/story_engine.py`
- `frontend/src/components/StoryScreen.tsx`

åŠŸèƒ½ç‚¹ï¼š
- æ•…äº‹æ®µè½ç”Ÿæˆæ—¶è°ƒç”¨ TTS ç”ŸæˆéŸ³é¢‘
- å‰ç«¯æ’­æ”¾ TTS éŸ³é¢‘ï¼ˆæ›¿æ¢æµè§ˆå™¨ Web Speech APIï¼‰
- éŸ³è‰²å‚æ•°é€ä¼ åˆ° TTS è¯·æ±‚

### 5.2 ç”»å»Šæ•…äº‹éŸ³è‰²è¦†ç›–
- ä»ç”»å»ŠåŠ è½½æ•…äº‹æ—¶ï¼Œä½¿ç”¨å½“å‰å…¨å±€éŸ³è‰²é‡æ–°ç”Ÿæˆ TTS
- æˆ–è€…ï¼šåœ¨æ’­æ”¾æ—¶åŠ¨æ€è°ƒç”¨ TTS API

### 5.3 å€é€Ÿè®°å¿†
- å·²å®ç°å‰ç«¯å€é€ŸæŒä¹…åŒ–
- éœ€è¦åœ¨æ’­æ”¾å™¨ä¸­åº”ç”¨å€é€Ÿè®¾ç½®

## å…­ã€å¸¸è§é—®é¢˜

### Q1: edge-tts å®‰è£…å¤±è´¥
**è§£å†³æ–¹æ¡ˆï¼š**
```bash
# macOS/Linux
pip install --upgrade edge-tts

# Windows
pip install --upgrade edge-tts --user
```

### Q2: é¢„è§ˆéŸ³é¢‘ç”Ÿæˆæ…¢
**åŸå› ï¼š** é¦–æ¬¡è®¿é—®æ—¶éœ€è¦ç”Ÿæˆé¢„è§ˆéŸ³é¢‘

**è§£å†³æ–¹æ¡ˆï¼š**
- åç«¯å¯åŠ¨æ—¶ä¼šè‡ªåŠ¨é¢„ç”Ÿæˆ 3 ä¸ªæ¨èéŸ³è‰²çš„é¢„è§ˆ
- å¯æ‰‹åŠ¨è§¦å‘é¢„ç”Ÿæˆï¼š
```bash
curl -X POST http://localhost:1001/api/voices/preview/zh-CN-XiaoxiaoNeural
```

### Q3: éŸ³é¢‘æ–‡ä»¶ 404
**æ£€æŸ¥ï¼š**
1. `backend/data/audio/` ç›®å½•æ˜¯å¦å­˜åœ¨
2. éŸ³é¢‘æ–‡ä»¶æƒé™æ˜¯å¦æ­£ç¡®
3. åç«¯æ—¥å¿—ä¸­æ˜¯å¦æœ‰ TTS ç”Ÿæˆé”™è¯¯

### Q4: è·¨åŸŸé—®é¢˜
**æ£€æŸ¥ï¼š**
- `backend/app/config.py` ä¸­çš„ CORS é…ç½®
- å‰ç«¯ API_URL æ˜¯å¦æ­£ç¡®

## ä¸ƒã€æ€§èƒ½ä¼˜åŒ–å»ºè®®

### 7.1 éŸ³é¢‘ç¼“å­˜
- âœ… å·²å®ç°ï¼šé¢„è§ˆéŸ³é¢‘ç¼“å­˜
- âœ… å·²å®ç°ï¼šTTS éŸ³é¢‘æŒ‰ story_id + segment_index + voice_id ç¼“å­˜
- å»ºè®®ï¼šå®šæœŸæ¸…ç†è¿‡æœŸéŸ³é¢‘æ–‡ä»¶

### 7.2 é¢„åŠ è½½
- âœ… å·²å®ç°ï¼šåå°é¢„ç”Ÿæˆæ¨èéŸ³è‰²é¢„è§ˆ
- å»ºè®®ï¼šé¢„åŠ è½½å¸¸ç”¨éŸ³è‰²çš„ç¤ºä¾‹éŸ³é¢‘

### 7.3 CDN åŠ é€Ÿ
- å»ºè®®ï¼šå°†éŸ³é¢‘æ–‡ä»¶ä¸Šä¼ åˆ° CDNï¼ˆå¦‚é˜¿é‡Œäº‘ OSSï¼‰
- å‡å°‘æœåŠ¡å™¨å¸¦å®½å‹åŠ›

## å…«ã€æ•°æ®åŸ‹ç‚¹ï¼ˆå·²å®šä¹‰ï¼Œå¾…å®æ–½ï¼‰

```typescript
// éŸ³è‰²ç›¸å…³
trackEvent('voice_preview_played', { voice_id, duration })
trackEvent('voice_selected', { voice_id, source })
trackEvent('voice_switch', { from_voice, to_voice })

// æ’­æ”¾ç›¸å…³
trackEvent('playback_started', { story_id, segment_index, voice_id })
trackEvent('playback_speed_changed', { speed, story_id })
trackEvent('seek_used', { from_time, to_time, story_id })
trackEvent('playback_completed', { story_id, duration })

// TTS ç›¸å…³
trackEvent('tts_requested', { story_id, segment_index, voice_id })
trackEvent('tts_success', { story_id, segment_index, voice_id, latency })
trackEvent('tts_failed', { story_id, segment_index, voice_id, error })
```

## ä¹ã€å®‰å…¨æ³¨æ„äº‹é¡¹

### 9.1 æ–‡ä»¶è·¯å¾„å®‰å…¨
- âœ… å·²å®ç°ï¼šéŸ³é¢‘æ–‡ä»¶è·¯å¾„éªŒè¯ï¼ˆé˜²æ­¢è·¯å¾„éå†æ”»å‡»ï¼‰
- âœ… å·²å®ç°ï¼šæ–‡ä»¶åå®‰å…¨æ£€æŸ¥

### 9.2 éŸ³è‰²éªŒè¯
- âœ… å·²å®ç°ï¼šéŸ³è‰² ID ç™½åå•éªŒè¯
- âœ… å·²å®ç°ï¼šæ— æ•ˆéŸ³è‰²è‡ªåŠ¨å›é€€åˆ°é»˜è®¤å€¼

### 9.3 ç”¨æˆ·åå¥½
- âœ… å·²å®ç°ï¼šå€é€ŸèŒƒå›´é™åˆ¶ï¼ˆ0.5 - 2.0ï¼‰
- âœ… å·²å®ç°ï¼šæœªç™»å½•æ—¶ä½¿ç”¨æœ¬åœ°ç¼“å­˜

---

**ç‰ˆæœ¬**: v1.0  
**å®Œæˆæ—¥æœŸ**: 2026-02-10  
**å¼€å‘çŠ¶æ€**: Phase 0-2 å·²å®Œæˆï¼ŒPhase 3ï¼ˆå¢é•¿åŠŸèƒ½ï¼‰å¾…å¼€å‘
